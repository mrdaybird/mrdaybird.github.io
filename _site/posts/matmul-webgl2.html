<!-------------------------------------------------------------------------------------
*
* MIT License
* Copyright (c) 2023 Vaibhav Pathak
*
* Permission is hereby granted, free of charge, to any person obtaining a copy
* of this software and associated documentation files (the "Software"), to deal
* in the Software without restriction, including without limitation the rights
* to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
* copies of the Software, and to permit persons to whom the Software is
* furnished to do so, subject to the following conditions:
*
* The above copyright notice and this permission notice shall be included in all
* copies or substantial portions of the Software.
*
* THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
* IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
* FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
* AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
* LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
* OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
* SOFTWARE.
*
------------------------------------------------------------------------------------>
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta content="width=device-width, initial-scale=1" name="viewport" />
    <meta content="Knowledge Continuum" property="og:site_name"/>
    <meta content="A non-linear thread of important ideas weaved together to explore and understand the fabric of knowledge." property="og:description">
    <meta content="http://localhost:4000/about/" property="article:author"><meta content="Matrix Multiplication using WebGL2" property="og:title">
    <meta content="article" property="og:type">
    <meta content="http://localhost:4000/posts/matmul-webgl2" property="og:url"><title>Eridanus</title>
    <link rel="canonical" href="http://localhost:4000/posts/matmul-webgl2"/>
    <link rel="apple-touch-icon" href="/assets/img/profile.png">
    <link rel="icon" href="/assets/img/favicon.png" type="image/png" sizes="16x16"/>
    <link href="/assets/css/Style.css" rel="stylesheet" media="all" class="default" />
    <link href="/assets/css/Util.css" rel="stylesheet" media="all" class="default" />
    <link href="/assets/css/vendor/Katex.css" rel="stylesheet" media="all" class="default"/>
    <!--[if IE]>
      <link href="/assets/css/ie-target.css" rel="stylesheet" type="text/css"/>
    <![endif]-->
    <!--<link href="/assets/css/prism.css" rel="stylesheet" />-->
    <link rel="alternate" type="application/rss+xml" href="http://localhost:4000/feed.xml">
  </head>
  <body>
    <div class="container">
      <div class = "box">
        <header>
          <div class="dashboard disable-select">
            <div class="site-heading-ltr profile-board-col">
              <p class="main-page-heading medium margin-top-0-neg"><a href='/'>Eridanus</a></p>
              <h4 class="main-page-subheading medium"><a href="/">Lessons on Life and Tech</a></h4>
              <p class="main-page-tagline">Notes on the things I have learned</p>
            </div>
          </div>
          <div class="main-site-subheader menu disable-select">
            <a class="menu-item" href="/about">
              <svg class="menu-item-icon" width="18" height="19" viewBox="0 0 25 25" fill="none"
                    xmlns="http://www.w3.org/2000/svg">
                <path
                        d="M20.9777 21.6138V19.6138C20.9777 18.553 20.5563 17.5356 19.8061 16.7854C19.056 16.0353 18.0386 15.6138 16.9777 15.6138H8.97768C7.91682 15.6138 6.8994 16.0353 6.14926 16.7854C5.39911 17.5356 4.97768 18.553 4.97768 19.6138V21.6138"
                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                  <path
                        d="M12.9777 11.6138C15.1868 11.6138 16.9777 9.82298 16.9777 7.61385C16.9777 5.40471 15.1868 3.61385 12.9777 3.61385C10.7685 3.61385 8.97768 5.40471 8.97768 7.61385C8.97768 9.82298 10.7685 11.6138 12.9777 11.6138Z"
                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                  </svg>
                  <p class="menu-item-text">About</p>
                </a>
                <a class="menu-item" href="/tags">
                  <svg class="menu-item-icon" width="18" height="19" viewBox="0 0 24 25" fill="none"
                    xmlns="http://www.w3.org/2000/svg">
                    <path d="M4 9.5H20" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M4 15.5H20" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M10 3.5L8 21.5" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M16 3.5L14 21.5" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                  </svg>
                  <p class="menu-item-text">Tags</p>
                </a>
                <!--  <a class="menu-item" href="/feed.xml">
                <svg class="menu-item-icon" width="18" height="19" viewBox="0 0 24 25" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M4 11.5C6.38695 11.5 8.67613 12.4482 10.364 14.136C12.0518 15.8239 13 18.1131 13 20.5"
                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M4 4.5C8.24346 4.5 12.3131 6.18571 15.3137 9.18629C18.3143 12.1869 20 16.2565 20 20.5"
                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    <path
                        d="M5 20.5C5.55228 20.5 6 20.0523 6 19.5C6 18.9477 5.55228 18.5 5 18.5C4.44772 18.5 4 18.9477 4 19.5C4 20.0523 4.44772 20.5 5 20.5Z"
                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                <p class="menu-item-text">RSS</p>
        </a> -->
              </div>
              <div class="searchbar search-container">
                <svg class="search-icon" width="19" height="19" viewBox="0 0 25 25" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M11.5 19.5C15.9183 19.5 19.5 15.9183 19.5 11.5C19.5 7.08172 15.9183 3.5 11.5 3.5C7.08172 3.5 3.5 7.08172 3.5 11.5C3.5 15.9183 7.08172 19.5 11.5 19.5Z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M21.5 21.5L17.15 17.15"  stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <div class="search-shortcut disable-select">
                  <kbd class="disable-select">Shift</kbd>
                  <kbd class="disable-select">s</kbd>
                </div>
                <label for="search-input"></label>
                <input type="text" id="search-input" autocomplete="off" placeholder="Search Eridanus..."/>
                <div id="search-results" class="search-results"></div>
              </div>
              <script type="text/javascript" src="/assets/js/vendor/lunr.min.js"></script>
              <script src="/assets/js/Search.js"></script>
              <div class="main-site-subheader disable-select" id="scroll-head" onclick="window.location.assign('/')" >
                <div class="back-icon" >
                  <svg class="ripple" xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24">
                    <path d="M0 0h24v24H0z" fill="none"/>
                    <path d="M21 11H6.83l3.58-3.59L9 6l-6 6 6 6 1.41-1.41L6.83 13H21z"/>
                  </svg>
                </div>
                <p class="back-p">Home</p>
              </div>
            </header>
            <main>
              <h1>Matrix Multiplication using WebGL2</h1>
              <!-- Parse internal links, external links, transclusions etc and manipuate the content to reflect it accordingly -->
              <ul class="tags">
                <li><a href="/dates/#14-May-2023" class="tag">May-14-2023</a></li>
                <!-- Loop through page categories and print them in tags -->
                <li><a href="/tags/#webgl" class="tag">webgl</a></li>
                <li><a href="/tags/#javascript" class="tag">javascript</a></li>
              </ul>
              <div class="content">
                <p>Let's start with some background on what we are dealing with here. If you are already familiar with webgl, you can skip the <em>Introduction</em> section to <a href="#clearing-the-ground-for-the-real-stuff">some real code</a>.</p>
                <p>Also, disclaimer, I wrote this blog because I could not find any good resources for the same, so learned to do it myself. I am a beginner to WebGL, so this blog is more like a personal note on things I have learned. </p>
                <h3 id="introduction">Introduction </h3>
                <p>Fundamental to any deep learning system is the ability to multiply two matrices, and to do it quickly and efficiently. GPUs are great at doing just that. They specialize in doing one thing at a large scale, using an architecture called <a href="https://en.wikipedia.org/wiki/Single_instruction,_multiple_threads">Single Instruction, Multiple Threads</a>, leveraging their many cores and threads. These features of the GPU enable them to process large amounts of data efficiently.</p>
                <p><strong>So what is a GPU?</strong></p>
                <p>Graphics Processing Units or GPUs were originally designed to perform efficient computer graphics and image processing. Later, it was realized that their design makes them appropriate tools for training neural networks, so currently in the market, some GPUs are optimized to utilize their computing capabilities.</p>
                <p><strong>What is WebGL?</strong> </p>
                <p>WebGL(Web Graphics Library) is a Javascript API for writing interactive 2D/3D graphics in the browser, leveraging the capabilities of the GPU. So, WebGL is not designed to perform general mathematical operations, so there will be boilerplate stuff that we have to deal with to reach our end goal. WebGL2 is a major update from the previous WebGL 1.0 that adds additional capabilities to the users, few of those features are very useful to us as well, which we will later see. </p>
                <p>From now on, WebGL will be stylized as <em>webgl</em>, and matrix multiplication will be shortened to <em>matmul</em>. So, let's start implementing our <em>matmul</em> code.</p>
                <p>We will be using a wrapper library over webgl called <a href="https://github.com/greggman/twgl.js/">twgl.js</a> to reduce the boilerplate code since webgl code can be lengthy and tedious. I will try to keep the code simple and stick to our orignal goal.</p>
                <h2 id="clearing-the-ground-for-the-real-stuff">Clearing the ground, for the <em>real</em> stuff</h2>
                <p>To keep things simple, we will be writing the entire code inside the HTML file. Since we will be using <em>twgl.js</em>, go ahead and get that from their <a href="https://github.com/greggman/twgl.js">github repo</a>. We will only be using the <em>twgl-full.module.js</em> file from it which is inside the <em>dist/5.x/</em> folder, you can copy that file to the current working directory. </p>
                <p>Create an <em>index.html</em> file, which will only contain our script. </p>
                <p>So your <em>index.html</em> should look something like this at this moment:</p>
                <figure class="highlight">
                  <pre><code class="language-html" data-lang="html"><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;body&gt;</span>
  <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"module"</span><span class="nt">&gt;</span>
    <span class="k">import</span> <span class="o">*</span> <span class="k">as</span> <span class="nx">twgl</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">twgl-full.module.js</span><span class="dl">'</span><span class="p">;</span>
  <span class="nt">&lt;/script&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span></code></pre>
                </figure>
                <p>To actually use webgl, we would have to get a <em>render context</em> from the <em>canvas</em> element.</p>
                <figure class="highlight">
                  <pre><code class="language-javascript" data-lang="javascript"><span class="kd">const</span> <span class="nx">canvas</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="dl">"</span><span class="s2">canvas</span><span class="dl">"</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">gl</span> <span class="o">=</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="dl">"</span><span class="s2">webgl2</span><span class="dl">"</span><span class="p">);</span></code></pre>
                </figure>
                <h2 id="writing-code-for-the-gpu">Writing code for the GPU</h2>
                <p>Since the GPU is a separate piece of hardware on the computer, writing code for the GPU is not the same as writing code for the CPU. GPU have their own processor and memory. To utilize them, you have to write programs called <em>shaders</em>. In webgl, shaders are written in a C-like language called GLSL. </p>
                <p><strong>Rendering pipeline</strong></p>
                <p>Since webgl was designed for rendering graphics, we have to write pairs of programs, called vertex shader and fragment shader. In webgl, the set of these shaders is called a <em>program</em>. </p>
                <p>The vertex shader is used to process and compute the vertex positions of a shape and the fragment shader computes the color of each pixel of the shape that is being drawn. </p>
                <p>To understand what is happening, take a look at this figure that shows the operations that are performed by webgl to render graphics on our screen:</p>
                <figure class="wp-caption">
                  <img src="/assets/img/renderingpipeline_webgl.png" /> 
                  <figcaption class="wp-caption-text">WebGL Rendering Pipeline <a href="https://www.geeksforgeeks.org/webgl-introduction/" target="_blank" rel="noopener noreferrer"><strong>Source</strong></a></figcaption>
                </figure>
                <p>In the end, what webgl is doing is calculating colors for each pixel on a 2D space. In webgl, what we render to is called <em>framebuffer</em>.  </p>
                <p>Another thing we should know about before we go on ahead is a <strong>texture</strong>. A texture is a 2D image, that is generally used to add detail to objects. These textures can also be used to store arbitrary data and the entire texture can be easily accessed by our shaders.</p>
                <h2 id="the-real-stuff">The <strong><em>real</em></strong> stuff</h2>
                <p>From what we have learned, we have answered a very important question: <strong>How will we be storing our matrices in the GPU?</strong></p>
                <p>We will be utilizing the following features of webgl2: 1. We can use textures to store arbitrary data. 2. Texture can be easily accessed by our shaders. 3. We can render to a texture using a framebuffer.</p>
                <p>This makes textures ideal candidates for storing matrices.</p>
                <p><strong>How will we be using vertex shaders and fragment shaders to multiply two matrices?</strong> </p>
                <p>As we have already learned, unlike CPU, GPU code works on multiple data at the same time. So, using the same CPU code, to our shaders will do us no good. What we will be doing is splitting our original task is smaller parts that are not interdependent. </p>
                <p>So, how can we split matrix multiplication into smaller parts?</p>
                <figure class="wp-caption">
                  <img src="/assets/img/matrixmultiplication.png" /> 
                  <figcaption class="wp-caption-text">Take a look at this picture to understand what is happening during matrix multiplication. To see the full animation, go to the original source of the snippet: <a href="https://www.geogebra.org/m/ETHXK756" target="_blank" rel="noopener noreferrer">Matrix Multiplication Animated Example</a></figcaption>
                </figure>
                <p>Matrix multiplication is essentially a series of dot-products between rows of the first matrices to the columns of the second matrices, to be more verbose we are multiplying the rows of the first matrix by columns in the second matrix.</p>
                <p>So, each shader will essentially be a dot product of a row and a column.</p>
                <p>Our vertex shader and fragment shader will look like this:</p>
                <figure class="highlight">
                  <pre><code class="language-javascript" data-lang="javascript"><span class="kd">const</span> <span class="nx">vs</span> <span class="o">=</span> <span class="s2">`
#version 300 es

in vec4 position;

void main(){
  gl_Position = position;
}
`</span><span class="p">;</span>
  
<span class="kd">const</span> <span class="nx">fs</span> <span class="o">=</span> <span class="s2">`
#version 300 es
precision highp float;

in vec4 position;

uniform sampler2D matA;
uniform sampler2D matB;

out vec4 outColor;

vec4 dotproduct(int rowIdx, int columnIdx, int rowLengthA){
    vec4 sum = vec4(0.0);

    for(int k = 0; k &lt; rowLengthA; k++){
      vec4 elementA = texelFetch(matA, ivec2(k, rowIdx), 0);
      vec4 elementB = texelFetch(matB, ivec2(columnIdx, k), 0);
      sum += elementA * elementB;
    }

    return sum;
}

void main(){
  ivec2 texelCoord = ivec2(gl_FragCoord.xy);
  int rowIdx = texelCoord.y;
  int columnIdx = texelCoord.x;

  ivec2 dimA = textureSize(matA, 0);

  outColor = dotproduct(rowIdx, columnIdx, dimA.x);
}
`</span><span class="p">;</span></code></pre>
                </figure>
                <p>Let's understand what is happening here. We will skip the vertex shader(stored in the <em>vs</em> variable) and look at the fragment shader(stored in the <em>fs</em> variable)</p>
                <ol>
                  <li>The variable <code class="highlighter-rouge">matA</code> and <code class="highlighter-rouge">matB</code> of type <code class="highlighter-rouge">uniform sampler2D</code>, are the textures storing the matrices A and B. The <code class="highlighter-rouge">sampler2D</code> refers to a 2D texture and <code class="highlighter-rouge">uniform</code> refers to the fact that these variables will be the same across all invocations of the shaders.  </li>
                  <li><code class="highlighter-rouge">outColor</code> is the output value of the pixel. </li>
                  <li>The <code class="highlighter-rouge">dotproduct</code> function computes the dot product of a row and a column. </li>
                  <li>The <code class="highlighter-rouge">texelFetch</code> function is an in-built function that looks up a pixel from a texture. It takes in the texture as the first parameter and <code class="highlighter-rouge">ivec2</code> (integer vector of dimension 2) as the second parameter. The third parameter is always 0. (<em>don't ask me idk why</em>)</li>
                </ol>
                <p>That's pretty much it in the fragment shader, which is our main piece of code.</p>
                <p>Let's go over the rest of the code that will create the textures and use the shaders to multiply two matrices.</p>
                <p>To store our shaders and compile them for the GPU, we have to create a <em>program</em>:</p>
                <figure class="highlight">
                  <pre><code class="language-javascript" data-lang="javascript"><span class="kd">const</span> <span class="nx">programInfo</span> <span class="o">=</span> <span class="nx">twgl</span><span class="p">.</span><span class="nx">createProgramInfo</span><span class="p">(</span><span class="nx">gl</span><span class="p">,</span> <span class="p">[</span><span class="nx">vs</span><span class="p">,</span> <span class="nx">fs</span><span class="p">]);</span></code></pre>
                </figure>
                <p>For our fragment shader to work for all pixels of our output texture, we will create a rectangle covering our entire texture:</p>
                <figure class="highlight">
                  <pre><code class="language-javascript" data-lang="javascript"><span class="kd">const</span> <span class="nx">arrays</span> <span class="o">=</span> <span class="p">{</span>
<span class="na">position</span> <span class="p">:</span> <span class="p">{</span> <span class="na">numComponents</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span>  <span class="na">data</span><span class="p">:</span> <span class="p">[</span>
    <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
     <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>
    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>
     <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
     <span class="mi">1</span><span class="p">,</span>  <span class="mi">1</span><span class="p">]</span>
    <span class="p">}};</span>

<span class="kd">const</span> <span class="nx">bufferInfo</span> <span class="o">=</span> <span class="nx">twgl</span><span class="p">.</span><span class="nx">createBufferInfoFromArrays</span><span class="p">(</span><span class="nx">gl</span><span class="p">,</span> <span class="nx">arrays</span><span class="p">);</span>
<span class="nx">twgl</span><span class="p">.</span><span class="nx">setBuffersAndAttributes</span><span class="p">(</span><span class="nx">gl</span><span class="p">,</span> <span class="nx">programInfo</span><span class="p">,</span> <span class="nx">bufferInfo</span><span class="p">);</span></code></pre>
                </figure>
                <p>Now let's create random data for our matrices.</p>
                <figure class="highlight">
                  <pre><code class="language-javascript" data-lang="javascript"><span class="kd">const</span> <span class="nx">n</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="nx">m</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">random</span><span class="p">(</span><span class="nx">N</span><span class="p">){</span>
<span class="kd">const</span> <span class="nx">arr</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Float32Array</span><span class="p">(</span><span class="nx">N</span><span class="p">);</span>

<span class="k">for</span><span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">N</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span>
  <span class="nx">arr</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">();</span>

<span class="k">return</span> <span class="nx">arr</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">A</span> <span class="o">=</span> <span class="nx">random</span><span class="p">(</span><span class="nx">n</span><span class="o">*</span><span class="nx">m</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">B</span> <span class="o">=</span> <span class="nx">random</span><span class="p">(</span><span class="nx">n</span><span class="o">*</span><span class="nx">m</span><span class="p">);</span></code></pre>
                </figure>
                <p>Now let's store the matrices in a texture.</p>
                <figure class="highlight">
                  <pre><code class="language-javascript" data-lang="javascript"><span class="kd">const</span> <span class="nx">textures</span> <span class="o">=</span> <span class="nx">twgl</span><span class="p">.</span><span class="nx">createTextures</span><span class="p">(</span><span class="nx">gl</span><span class="p">,</span> <span class="p">{</span>
<span class="na">matA</span> <span class="p">:</span> <span class="p">{</span>
  <span class="na">width</span> <span class="p">:</span> <span class="nx">m</span><span class="p">,</span>
  <span class="na">height</span> <span class="p">:</span> <span class="nx">n</span><span class="p">,</span>
  <span class="na">src</span> <span class="p">:</span> <span class="nx">A</span><span class="p">,</span>
  <span class="na">internalFormat</span> <span class="p">:</span> <span class="nx">gl</span><span class="p">.</span><span class="nx">R32F</span><span class="p">,</span>
  <span class="na">format</span> <span class="p">:</span> <span class="nx">gl</span><span class="p">.</span><span class="nx">RED</span><span class="p">,</span>
  <span class="na">minMag</span> <span class="p">:</span> <span class="nx">gl</span><span class="p">.</span><span class="nx">NEAREST</span>
<span class="p">},</span>
<span class="na">matB</span> <span class="p">:</span> <span class="p">{</span>
  <span class="na">width</span> <span class="p">:</span> <span class="nx">n</span><span class="p">,</span>
  <span class="na">height</span> <span class="p">:</span> <span class="nx">m</span><span class="p">,</span>
  <span class="na">src</span> <span class="p">:</span> <span class="nx">B</span><span class="p">,</span>
  <span class="na">internalFormat</span> <span class="p">:</span> <span class="nx">gl</span><span class="p">.</span><span class="nx">R32F</span><span class="p">,</span>
  <span class="na">format</span> <span class="p">:</span> <span class="nx">gl</span><span class="p">.</span><span class="nx">RED</span><span class="p">,</span>
  <span class="na">minMag</span> <span class="p">:</span> <span class="nx">gl</span><span class="p">.</span><span class="nx">NEAREST</span>
<span class="p">}</span>
<span class="p">});</span></code></pre>
                </figure>
                <p>We have to tell the program where the textures are. The <em>twgl.js</em> lib makes it easy things easy for us. For now, let's store the textures in an array. </p>
                <figure class="highlight">
                  <pre><code class="language-javascript" data-lang="javascript"><span class="kd">const</span> <span class="nx">uniforms</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">matA</span> <span class="p">:</span> <span class="nx">textures</span><span class="p">.</span><span class="nx">matA</span><span class="p">,</span>
  <span class="na">matB</span> <span class="p">:</span> <span class="nx">textures</span><span class="p">.</span><span class="nx">matB</span>
<span class="p">};</span></code></pre>
                </figure>
                <p>We also have to create an output texture for the resultant matrix. But before we do that, we have to enable an extension, since rendering to texture with floating-point values is not enabled by default. </p>
                <figure class="highlight">
                  <pre><code class="language-javascript" data-lang="javascript"><span class="kd">const</span> <span class="nx">ext</span> <span class="o">=</span> <span class="nx">gl</span><span class="p">.</span><span class="nx">getExtension</span><span class="p">(</span><span class="dl">"</span><span class="s2">EXT_color_buffer_float</span><span class="dl">"</span><span class="p">);</span></code></pre>
                </figure>
                <p>Let's create our output texture and bind it to a framebuffer:</p>
                <figure class="highlight">
                  <pre><code class="language-javascript" data-lang="javascript"><span class="kd">const</span> <span class="nx">matC</span> <span class="o">=</span> <span class="nx">twgl</span><span class="p">.</span><span class="nx">createTexture</span><span class="p">(</span><span class="nx">gl</span><span class="p">,</span> <span class="p">{</span>
    <span class="na">width</span> <span class="p">:</span> <span class="nx">n</span><span class="p">,</span>
    <span class="na">height</span> <span class="p">:</span> <span class="nx">n</span><span class="p">,</span>
    <span class="na">internalFormat</span> <span class="p">:</span> <span class="nx">gl</span><span class="p">.</span><span class="nx">R32F</span><span class="p">,</span>
    <span class="na">format</span> <span class="p">:</span> <span class="nx">gl</span><span class="p">.</span><span class="nx">RED</span><span class="p">,</span>
    <span class="na">type</span> <span class="p">:</span> <span class="nx">gl</span><span class="p">.</span><span class="nx">FLOAT</span><span class="p">,</span>
    <span class="na">minMag</span> <span class="p">:</span> <span class="nx">gl</span><span class="p">.</span><span class="nx">NEAREST</span>
  <span class="p">});</span>
  
  <span class="kd">const</span> <span class="nx">attachments</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span> <span class="na">format</span> <span class="p">:</span> <span class="nx">gl</span><span class="p">.</span><span class="nx">RED</span><span class="p">,</span>
      <span class="na">attachment</span> <span class="p">:</span> <span class="nx">matC</span><span class="p">,</span>
      <span class="na">type</span> <span class="p">:</span> <span class="nx">gl</span><span class="p">.</span><span class="nx">FLOAT</span><span class="p">,</span>
    <span class="p">}</span>
  <span class="p">];</span>
  
<span class="kd">const</span> <span class="nx">fbi</span> <span class="o">=</span> <span class="nx">twgl</span><span class="p">.</span><span class="nx">createFramebufferInfo</span><span class="p">(</span><span class="nx">gl</span><span class="p">,</span> <span class="nx">attachments</span><span class="p">,</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">n</span><span class="p">);</span></code></pre>
                </figure>
                <p>Now, we just have to set the input textures and render to the output texture.</p>
                <figure class="highlight">
                  <pre><code class="language-javascript" data-lang="javascript"><span class="nx">gl</span><span class="p">.</span><span class="nx">bindFramebuffer</span><span class="p">(</span><span class="nx">gl</span><span class="p">.</span><span class="nx">FRAMEBUFFER</span><span class="p">,</span> <span class="nx">fbi</span><span class="p">.</span><span class="nx">framebuffer</span><span class="p">);</span>

<span class="nx">gl</span><span class="p">.</span><span class="nx">viewport</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">n</span><span class="p">);</span>
<span class="nx">gl</span><span class="p">.</span><span class="nx">useProgram</span><span class="p">(</span><span class="nx">programInfo</span><span class="p">.</span><span class="nx">program</span><span class="p">);</span>
<span class="nx">twgl</span><span class="p">.</span><span class="nx">setUniforms</span><span class="p">(</span><span class="nx">programInfo</span><span class="p">,</span> <span class="nx">uniforms</span><span class="p">);</span>
<span class="nx">twgl</span><span class="p">.</span><span class="nx">drawBufferInfo</span><span class="p">(</span><span class="nx">gl</span><span class="p">,</span> <span class="nx">bufferInfo</span><span class="p">);</span></code></pre>
                </figure>
                <p>At this point, our output texture will contain the resultant matrix, we can read the texture as follow:</p>
                <figure class="highlight">
                  <pre><code class="language-javascript" data-lang="javascript"><span class="kd">const</span> <span class="nx">pixels</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Float32Array</span><span class="p">(</span><span class="nx">n</span><span class="o">*</span><span class="nx">n</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span>
<span class="nx">gl</span><span class="p">.</span><span class="nx">readPixels</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">gl</span><span class="p">.</span><span class="nx">RGBA</span><span class="p">,</span> <span class="nx">gl</span><span class="p">.</span><span class="nx">FLOAT</span><span class="p">,</span> <span class="nx">pixels</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">results</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Float32Array</span><span class="p">(</span><span class="nx">n</span><span class="o">*</span><span class="nx">n</span><span class="p">);</span>
<span class="k">for</span><span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="o">*</span><span class="nx">n</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span>
<span class="nx">results</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">pixels</span><span class="p">[</span><span class="nx">i</span><span class="o">*</span><span class="mi">4</span><span class="p">];</span></code></pre>
                </figure>
                <p>Let's also display our matrices in the window.</p>
                <figure class="highlight">
                  <pre><code class="language-javascript" data-lang="javascript"><span class="nx">displayMatrix</span><span class="p">(</span><span class="nx">A</span><span class="p">,</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">m</span><span class="p">,</span> <span class="dl">"</span><span class="s2">A</span><span class="dl">"</span><span class="p">);</span>
<span class="nx">displayMatrix</span><span class="p">(</span><span class="nx">B</span><span class="p">,</span> <span class="nx">m</span><span class="p">,</span> <span class="nx">n</span><span class="p">,</span> <span class="dl">"</span><span class="s2">B</span><span class="dl">"</span><span class="p">);</span>
<span class="nx">displayMatrix</span><span class="p">(</span><span class="nx">results</span><span class="p">,</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">n</span><span class="p">,</span> <span class="dl">"</span><span class="s2">C</span><span class="dl">"</span><span class="p">)</span>

<span class="kd">function</span> <span class="nx">displayMatrix</span><span class="p">(</span><span class="nx">mat</span><span class="p">,</span> <span class="nx">N</span><span class="p">,</span> <span class="nx">M</span><span class="p">,</span> <span class="nx">tag</span><span class="p">){</span>
    <span class="nx">log</span><span class="p">(</span><span class="s2">`</span><span class="p">${</span><span class="nx">tag</span><span class="p">}</span><span class="s2">:\n</span><span class="p">${</span><span class="nx">createMatString</span><span class="p">(</span><span class="nx">mat</span><span class="p">,</span> <span class="nx">N</span><span class="p">,</span> <span class="nx">M</span><span class="p">)}</span><span class="s2">`</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">createMatString</span><span class="p">(</span><span class="nx">mat</span><span class="p">,</span> <span class="nx">N</span><span class="p">,</span> <span class="nx">M</span><span class="p">){</span>
    <span class="kd">let</span> <span class="nx">str</span> <span class="o">=</span> <span class="dl">""</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">N</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">){</span>
      <span class="k">for</span><span class="p">(</span><span class="kd">let</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">M</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">){</span>
        <span class="nx">str</span> <span class="o">+=</span> <span class="s2">`</span><span class="p">${</span><span class="nx">mat</span><span class="p">[</span><span class="nx">i</span> <span class="o">*</span> <span class="nx">M</span> <span class="o">+</span> <span class="nx">j</span><span class="p">].</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">5</span><span class="p">)}</span><span class="s2"> `</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">str</span> <span class="o">+=</span> <span class="dl">'</span><span class="se">\n</span><span class="dl">'</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">str</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">log</span><span class="p">(...</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">elem</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="dl">'</span><span class="s1">pre</span><span class="dl">'</span><span class="p">);</span>
    <span class="nx">elem</span><span class="p">.</span><span class="nx">textContent</span> <span class="o">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="dl">'</span><span class="s1"> </span><span class="dl">'</span><span class="p">);</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">elem</span><span class="p">);</span>
<span class="p">}</span></code></pre>
                </figure>
                <p>Voila, we have multiplied two matrices using webgl. Yay!</p>
                <p>Here's the complete code:</p>
                <script src="https://gist.github.com/mrdaybird/7c0978f8752db96d7d659090bd50a9b9.js"></script>
                <h3 id="references">References</h3>
                <ol>
                  <li><a href="https://webgl2fundamentals.org/">WebGL2 Fundamentals</a> is a good resource for learning about webgl in general.</li>
                  <li><a href="https://webgl2fundamentals.org/webgl/lessons/webgl-gpgpu.html">WebGL2 GPGPU</a> is an excellent source for learning about general purpose programming using webgl. <strong>This is where I began.</strong></li>
                  <li><a href="https://www.google.com/search?client=firefox-b-d&amp;q=learnopengl">LearnOpenGL</a></li>
                </ol>
              </div>
              <!-- Add backlinks to the current page --></main><!-- DISQUS COMMENT SECTION, DO NOT TOUCH -->
            <div id="disqus_thread"></div>
            <script>
              /**
               *RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
               *LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
              var disqus_config = function () {
              this.page.url = 'http://localhost:4000/posts/matmul-webgl2';  // Replace PAGE_URL with your page's canonical URL variable
              this.page.identifier = 'http://localhost:4000/posts/matmul-webgl2'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
              };
              
              (function() { // DON'T EDIT BELOW THIS LINE
              var d = document, s = d.createElement('script');
              s.src = 'https://rgvr.disqus.com/embed.js';
              s.setAttribute('data-timestamp', +new Date());
              (d.head || d.body).appendChild(s);
              })();
            </script>
            <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
            <div id="copyright">
              <p id="copyright-notice">© Vaibhav Pathak. 2023</p>
            </div>
          </div>
        </div>
        <!-- Load KaTeX --></body>
    </html>